# データシート

https://aitendo3.sakura.ne.jp/aitendo_data/product_img/ic/inteface/GL850G/GL850G-HHY22.PDF

# 参考回路

参考回路 A:

https://github.com/llegoff/USB_Hub

実物写真があるので、動く物である可能性が高いので、これを一番優先と考える。

参考回路 B:

https://github.com/RyanDam/TinyUSBHub

参考回路 C:

https://github.com/veis-lzf/GL850G-USB2.0-HUB

# 挑戦 1.0

## ピンの把握

まず、各ピンの配線を見ていく。

### PREF

Table 3.4 によると 680Ω抵抗を介して GND につなぐ。正確には analog ground と買いてあるが、
参考回路は GND は全部共通としてるので GND で良いのだろう。

なんとなく 3.3V レギュレータに使う抵抗の気がするのだけど、これ IC に内蔵できなかったのだろ
うか。

ちなみに MA8601 のときは、この手の情報がデータシートに全くなかった。

### OVCUR1#

Table 3.4 によると Low とすると過電流を検知ということになる。電流チェック用の IC を使って
電流チェックする予定はないので、つねに High にしておけば良いはずだ。

参考回路 A は OVCUR1# を抵抗を使って 5V を 3.3V に落として入力している。このピンは 5V 耐圧
なので、5V そのままでも良さそうだが、わざわざ落としている。参考 B, C も 3.3V としている。
IC が 3.3V なら、耐圧 5V と書いてあっても 3.3V に落とすのが一般的なのだろうか。ちなみに
Table 6.3 によると 2V で High 判定となるようだ。また Table 6.2 によると定格運用範囲は 5.0V
までのようだ。そうなると誤差を考えると 5V そのまま入力するのは、動作が怪しくなるかもしれな
い。適当に確実に 5V より小くしておくのが無難ということで 3.3V で良いのだろう。

一つ疑問なのはレギュレータが 3.3V を V33 ピンに出力するので、それを入れたら良いのではない
かというところ。

ということで、次のテストはしてみたい。

- 適当に 3.3V ではないが、確実に 5.0V 以下にしたものを入力しても動くのか
- V33 ピンから直接入れたら動くのか

### OVCUR2#

どの参考回路も未使用となっている。

結論から行くと、ギャングモード (過電流をハブ合計で監視する方法) では OVCUR#1 のみ使用すれ
ば良いからである。そして参考回路はすべて PGANG に High を入力することで ギャングモードとな
っている。なので入力しなくて良いのである。

### PWREN1#, 2#

どの参考回路でも未使用。電力が来てるかどうかの出力ピンなので、使う必要はない。

### PSELF

High でセルフパワー、Low でバスパワー。電流管理を始めからしていないので、どっちでも良いは
ず。

参考回路 A, B は 10kΩを介して High としている (回路自体はバスパワーである)。参考回路 C は
未使用だが、それで良いのか？

ということで、次のテストはしてみた。

- PSELF を未使用として動作するのか

### PGANG

起動時に High にしておくとギャングモードとなる。もちろん電流管理をしないので、どうでも良い
はずではある。ただしギャングモードにしておくと OVCUR2# ピンを未使用にできる。

全ての参考回路でギャングモードは High に設定されている。5.2.2節によるとプルアップ抵抗は
100kΩが指定されている。

## RESET#

起動時に 10kΩでプルアップするように指定。Table 6.2 によると OVCUR1# と定格運用電圧上限は
同じ 5.0V なのに、参考回路 A では 5V にそのままプルアップしている。Table 6.1 によると 5.5V
までは壊れないけど、動作範囲に収めるべきなのでは？？？

一方、参考回路 C では抵抗を使って 4.1V の入力としている。

OVCUR#1 をわざわざ 3.3V に落とすんだから、こちらも、参考回路 C のように少しは落としたい。

また、一方でコンデンサを介して GND にもつないである。これは 5.2.1 節が関係していると思う。
リセットピンは VDD がしっかり立ち上がったあと 3usec 以上の時刻を掛けて High にならないとい
けない。参考回路 A は 1uF、B と C は 0.1uF となっている。10kΩ抵抗と直列なので時定数は
0.01s ~ 0.001s となる。しっかり計算していないが 3us より 3桁大きいので十分だろう。またフィ
ルター目的ではないのでセラコンでも電解コンでも良いはずだ。

次のことは試したい

- 0.1uF, 1uF どちらでも動くのか
- セラコン、電解コン、どちらでも動くか
- 内蔵レギュレータ 3.3V へのプルアップで動くか

### TEST

参考回路 A, B はプルダウンしているが、Table 3.4 によると Internal pull down なので回路 C
のように、未使用で良いはずである。

次のことは試したい。

- 未使用で問題ないか

### AVDD

IC 用 3.3V 入力ピン。参考回路毎にまちまち。

回路 A は 3.3V から最初に 47uH のコイルを通してから入力。

回路 B はコイル無しで 3.3V をそのまま入力。

回路 C は 3.3V をフェライトビーズを通して入力。

試したいこと

- オシロで 3.3V 出力の様子と、コイル (とコンデンサ) を追加するとどう変化するのか

### DVDD 

これも 3.3V 電源供給用のピン。どの参考回路においても 3.3V 出力をそのまま入力している。

## 電源安定化関係

### 5V ライン

参考回路 A は 10uF 電解x1, 100uF 電解x2, 0.1uF x5 となっている。10uF, 100uF は電力タンクの
役目だと思うので、1個で良いんじゃないか。また USB 子機に対しても 0.1uF をつけてるけど、そ
のフィルタの役目は、接続機器がそれぞれ行なうべきことなのではないだろうか。

参考回路 B は 10uF x1 と 0.1uF x1 のみ。

参考回路 C は 100uF x4 と 0.1uF x4 とフェライトビーズ。正直、ここに入れるのはどうなのか。
GL850G は 3.3V で動作するので、安定化させるなら 3.3V ラインにすべき

自分的には 100uF 超えるものを一つと 0.1uF を一つで良いのではないかと思う。

### 3.3V ライン

参考回路 A は 10uF x1 と 0.1uF x1 を 3V3 出力ラインに、0.1uF x3 を AVDD 入力ラインに入れて
いる。また AVDD ラインには 47uH のコイルを入れている。

コンデンサに関しては、出力ラインで整えたのであれば、入力ラインには何も要らないのではないだ
ろうか。またコイルに関しては、なぜ 3.3V - DVDD間にはコイルを入れないのかというところだ。

参考 B は 0.1uF x3 を出力ラインに入れている。電気的な意味は、特定の周波数へのフィルタを 3
倍掛けるということになるのだが、そんなに変なスパイクが出るのだろうか? 単に AVDD が 3ピンあ
るからコンデンサも 3個にしているというだけなら無意味ではないだろうか。

参考 C はまず 10uF、それからフェライトビーズを通した後に 1uF x1, 0.1uF x4 を入れているので、
参考 A と似たような感じだ。

3.3V 出力は九工大オシロで観察できるので、一度観察してからにはなるが、自分的には 47uF コイ
ル x1, 0.1uF コンデンサ x1, 10uF コンデンサ x1 で良いのではないかと思っている。

## ブレボテストの流れ

1. まずは参考回路 A の通りに行う。
   - ただし丁度の抵抗、コンデンサを揃えるのはリスクなので適当に近いところで行う。
   - ただし RREF の 680Ω, PGANG の 100kΩなどデータシートで指定されているところは、そのも
     のを使う。
2. ピンと電源のところで疑問に思ったところを、確かめてみる

