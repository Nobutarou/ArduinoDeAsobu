# typeC 充電器

## 参考サイト

https://elchika.com/article/daa1d3b6-acf8-450e-b9a9-974bb2a755d7/

参考サイト1 として回路図を参考にさせてもらう。

https://www.marubun.co.jp/technicalsquare/10483/

参考サイト2 で、typeC 給電の仕組みを学べるサイト。正直、今の自分には理解できない部分が多い。

## 回路1

まずは、参考サイト1 の通りの回路を組んでみる。黒塗りの抵抗だけど、参考サイト2 によれば 56k
Ωで 0.5A, 22kΩで 1.5A、10kΩで 3A ということらしい。

ということで、黒塗り抵抗を 10kΩにすると最大 5V 3A の充電ができるような気がするので、これ
は実際に抵抗を変えてテストだ。

参考サイト1 の回路でできるのは、参考サイト2 の「Source(USB Host)-to-Sink(USB Device)の決定」
節の「Sinkとの接続(connect)が確立したと認識して、VBUS(5V)を出力」までと考えられる。

リレーの所の動きを理解したい。CC1, CC2 の先には参考サイト2 によると 5.1kΩを遠して GND 接
続である。CC1, CC2 と比較している先の抵抗は 2kΩである。なのでスイッチが閉じると CC1/2 の
方が電圧が高くなる。

また、そこで使われているコンパレータ NJM2403 は電流を引き込むことしかできないので、HI のと
きに、負荷を掛けて電力を供給するという使い方はできず、LOW のときに他から電力を引き込む形と
なる。

電源投入時は CC1, CC2 が開いているので、コンパレータは V- > V+ となり、電力を引き込んでス
イッチが閉じる。閉じた先には 5.1kΩがあるのでやはり V- > V+ のままだから閉じたままである。
CC の接続先が Rd から変化しないのであれば、CC は始めから閉じたままで良い気がするのだが。 

規格が分かっていないのだけど、もし仮にシンク側で CC1 の Rd を2kΩよりも小さくすることがで
きるとすると、 CC1 の V+ > V- のため CC2が開く。CC2 が開くと CC2 の V- > V+ のため CC1 は
閉じたまま。

この辺は、実際に試してみないと、理解も進まなそうだ。

あと回路図に描かれてないけど NJM2403 には V+ と GND の配線も必要だ。その辺は省いてよい業界
のルールがあるのかもしれない。


## 部品選定

SS1A05D は信仰上の理由で買えないので、東芝あたりのフォトカプラで代用できそうだ。

まずリレースイッチには東芝 TLP785 フォトカプラを使う。何か選ばないと始まらないので。データ
シートによると、IF (発光側電流) = 16 - 25 mA が推奨となっている。対数グラフだから適当だけ
ど IF=16mA で VF=1.2V弱, IF=25mA で VF=1.2V 強なので電圧は 1.2V を目指せば良さそうだ。なお
測定試験では IF=10mA で行なっているので 10mA でも十分動くはず。そのときのVF=1.15V なので、
結局 1.2V 付近を目指せば良さそう。

次はコンパレータで、こちら 10mA 以上の出力が大丈夫なものが必要になる。ルネサスの HA17339A
が 4回路 (も要らないけど) あって 20mA 吸い込みできるので大丈夫だろう。

で、間に手持ちの 300Ω抵抗を挟めば、3.8V で 12.7mA なので、まああとは実際の動きを見て調整
だろう。

| 識別子   | 品名           | 品番            | メーカー    | 個数 |
| -----    | ----           | ----            | --------    | ---- |
| RR1,2    | フォトカプラ   | TLP785(GB F)    | 東芝        | 2 |
| NJM2403  | コンパレータ   | HA17339A        | ルネサス    | 1 |
| 記載なし | 抵抗 300Ω     | 手持ちのなにか  | どこか      | 2 |
| 10uF     | 電解コンデンサ | 50PX10MEFC5X11  | ルビコン    | 1 |
| 0.1uF    | セラコン       | 手持ちのなにか  | どこか      | 2 |
| 200Ω    | 抵抗 200Ω     | REY25FY 200Ω   | タクマン    | 1 |
| 2kΩ     | 抵抗 2kΩ      | REY25FY 2KΩ    | タクマン    | 2 | 
| 黒塗り   | 抵抗 10kΩ     | 手持ちのなにか  | どこか      | 4 |
| 黒塗り   | 抵抗 22kΩ     | REY25FY 22KΩ   | タクマン    | 4 |
| 黒塗り   | 抵抗 56kΩ     | REY25FY 56KΩ   | タクマン    | 4 |
| K-13080  | typeC DIP化基板| AE-USB2.0-TYPE-C-5077CR | 秋月 | 1 |

## 配線図 

一応描いてみたけど、フォトカプラやコンパレータはいかにも向きを間違えそうだ。すでに間違えて
いるかもしれない。

[配線図 kicad](./kicad/typeC/typec_kicad.pdf)

Android スマホでのテスト結果

| 黒塗り抵抗 [Ω]  | 電流 [A]  | 
| ---              | ---       |
| 56k              | 0.3 - 0.4 |
| 22k              | 0.7 - 0.8 | 
| 10k              | 0.4       |

これだけだと回路を間違えているのか分からないので D-, D+ のみに 200Ωというのも試したところ
0.1A であったため、一応動作はしたようだ。

しかし、typeA の D-, D+ に 200Ωはさむだけで、1.5A 程度出ていて、typeC はそれを越えること
を期待していたので、残念な結果だった。

またテスターやオシロで各所の電圧を観察してみたけど、結局正しい状態を分かっていないので、是
非の判断ができなかった。

typeC 充電は完全に力不足だった。とりあえず、実力が伴うまで本プロジェクトは凍結する。
