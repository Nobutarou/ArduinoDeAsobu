# これは何

PWM ファンを PID 制御して対象物の温度を目標値にする。
通常のファンコントローラは、特定温度まで一定回転、そこを越えると比例回転となるのが一般的だ
けど、つまらないので PID で制御してみることにした。

PID 制御については、こちらがとても分かりやすかった。

https://kurobekoblog.com/pid

# 配線について

![配線図](./pic/schematic_capture.png "配線図")

1.8V 定圧レギュレータを (U1) 使ったのは、温度センサーの出力が大きくても 0.5~1.5V なので、
参照電圧 3.3, 5V では大き過ぎる気がしたからだ。というのもピンを変えるたびに、そして 12V 電
源を差すか差さないかで、値が変わったからだ。しかし、実際のところは良く分からない。1.8V を
参照電圧にしたところで、やっぱりピンと12V 電圧の差す差さないで値は変わった。あと多分いくつ
かのピンを壊してると思うし、正直、今後ちゃんと壊さずに作業できるようになったときに、どうす
るかだな。

コンデンサ (C1) は要らないんじゃないかと思う。良く知らんが電源投入時の安定のためだと思うん
だけど、温度センサーは応答が遅いから、正直電源を入れた直後に多少なにかあっても、どうでも良
さそうに思うからだ。

# プログラムについて (ATmega328P で実装したいからボツにする)

Uno R4 は PWM 関数が追加されてるから簡単に可聴域越えの周波数での動作ができた。今後
Atmega328P での作成も考えてるから、この関数は使えない。まあそのときで。

<a href="Pwm-Temp.ino" target="_blank">UNO R4 向けプログラム</a>

# シールド実装 (ATmega328P で実装したいからボツにする)

![シールド設計図](./pic/FanConShield.png "シールド設計図")

なるべく裏配線が交差しない配置を考えてみた。どうしても温度センサー出力を A3 に持っていくと
こだけは交差するので、そこだけコネクタで表を走らせることにする。ググると被覆コードで全部や
る人が多いみたいだけど、はんだに自身がないので。

またボードの外からの接続も含めて、コネクタは JST XH コネクタにした。2.5mm ピッチで普通に
2.54mm ピッチのボードに差さるらしいし、しっかりと差さって抜けないことを知ってるので採用し
てみる。

ボードは余りそうなので、折って小さくできそうだ。

# ユニバーサル基板に実装 (保留)

![基板設計図](./pic/Pwmfan-temperature-controller-DIY.png "ユニバーサル基板設計図")

プログラムも書いてないのに設計だけしてみた。ピンは UNO R4 で生きていたピンのまま。もし PWM
でうるさいなど問題があれば D10 を使えば 20kHz やれそう。

https://rtmrw.parallel.jp/laboratory6/lab-report-157/lab-157.html

問題はあるみたいだけど、今回、他のデジタルピンは使わないから大丈夫ではないかな。

できたと思ったんだけど、PIC ならもっと小さくできそう。今実際にファンコンで困ってない
ので、慌てて作る必要もないので PIC も調べてみる

# PIC12F1572 でプログラムを書いてみようとした --> 挫折

--> PIC12F1752 のデータシートと格闘しながらプログラムを買いていたんだけど、プログラム領域
が圧倒的に足りない。あらかじめ紙と鉛筆で計算しておいて、最終式だけ書くとかすると達成できる
のかもしれないけど、そうなると、自分でもコードを読めなくなってしまう。おそらく達人の技が必
要そう、と言うことで、PIC は諦める。

# Arduino UNO R3 向けにもプログラムを書いてみる

R4 はフラッシュメモリが 256kB あり、プログラムが 56kB で問題なかったが、R3 のフラッシュメ
モリは 32kB だから足りなくない？ということで、こちらも見直しが必要になりそうな気配。先走っ
てハード買ってなくて良かった。

で

![R3 用 Arduino の PWM のソース](./Pwm-Temp_R3.ino)
![R3 用 2kHz の PWm のソース](./Pwm-Temp_R3_2kHz.ino)

は、どちらも 4kB 強のプログラムとなった。ブートローダが 1kB 強だから、合計 6kB くらいか。
PIC で 4kW くらいあるやつなら自分レベルでも書けるかもしれない。

# PIC をもう一度探してみる
--> PIC24F08KL200-I/P は 19mm 長で、プログラムメモリが 8kB (word じゃない!) で PWM も使え
るぞ。

--> 良くみたら命令長さが 20ビットに増えててワード数としては大差ないみたいな気がしてきた。

--> そもそもこの機種だと PWM 使えなかった

--> PIC16F15325-I/P は PWM 確実にあるぞ。命令調 14bit で 8kw の領域があるから,
8000x14/8=14kB くらい使えそうな気がす。19mm 長だし、もう一度挑戦してみよう

データシートと格闘しながら、エラーなくコンパイルしたものは出きた。シミュレーションでは動い
ているように見えるけど。 

![PIC16F15325 でのファンコンのソース](./PIC16F15325/TempPwmController.X/main.c)

水晶と参照電源まで省ける結果となった

# PIC16F15325 での配線図と基板

そもそも PIC の最小構成すら知らない。データシートの図2-1 に描いてある。で回路はこうなった。

![PIC16F15325 版の回路図](./pic/回路図PIC16F15325版.png)

でユニバーサル基板への設計はこうなった。縦に 2行くらい詰められそうだけど、それは現場で考え
る。

![PIC16F15325 版のユニバーサル基板設計](./pic/StripBoardDesign_for_PIC16lF15325.png)

心配事は

* FT232RL で本当に書き込めるかな
* 動くのかな

で、プログラマとして使おうと思ってた 
https://github.com/gphalkes/fpicprog
でサポートリストに載っていない。多分自分でデバイスリストを書けばできるんだけど、調べかたが
分からん。

もう一つ見つけた
https://github.com/jaromir-sukuba/a-p-prog
これならできそう。もともと壊した UNO R4 の変わりに UNO R3 は 1台は持っておこうと思ってたし、
FT232RL 購入ついでに付いてくる Aki のマイコンボード自体も UNO R3 の代わりをしてくれそうだ
し。

ただ、先のコードをコンパイルしたら 2572 words だったので、fpicprog のデバイスリストで入り
そうなのを調べていたら PIC12F1840-I/P という 8ピンで ADC も PWM も使えるものを見つけてしま
った。

またコード書き直そう。PIC ってハード買う前から遊べるのすげえな。種類が多くて切りがない。

# PIC12F1840 でもやってみる 

これはもともと狙っていた fpicprog でサポートされてるし、a-p-prog では、なんとテスト済でも
ある。これは確実だ。コードが書ければだけど。

--> 書けた
![PIC12F1840用のソース](./pic12f1840/mplabx/main.c)

--> 配線図の PDF
![PIC12F1840 での配線図](./pic12f1840/kicad/PicFanController.pdf)

--> ユニバーサル基板での部品配置図の PDF。配線を交差させたら負けだと思ってたけどジャンパー抵抗というの
を知った。単に交差させてるだけなのになんかそれっぽいから、気が楽になった

![PIC12F1840 での部品配置図](./pic12f1840/librecad/FanConPic12F1840.pdf)

正直 nMCLR にプルアップが必要なのか分からない。なぜならデータシートによると weak pullup が
デフォルトで有効だからだそうだ。weak って何だよ。何Ωとか言ってくれよ。っていうか
PIC16F16325 みたいに、最小構成も載せておいてくれよ。

--> ブレッドボードでのテストは nMCLR への配線は不要だった。

![PIC12F1840 用の配線図、その 2](./pic12f1840/kicad/配線図_nMCLR無し.png)

![PIC12F1840 での部品配線図、その 2](./pic12f1840/librecad/Design_without_nMCLR.png)

とはいえ 1行しか小くできなかった。

さて、ここまで組んでレギュレータのテストをしたらレギュレータが焦げた。

![テストしたときの図](./pic12f1840/fig/Regulator_test_to_break.png)

ここまで組んでレギュレータのテストをしたらレギュレータが焦げた。
知恵袋に聞いたことと、そこから考えたことは、

* コンデンサと適当に扱うな。必要だから付けろと仕様書は言っているのだ。
* コンデンサはなるべくレギュレータに近くに配置するべし
* 5V ラインにもちゃんとコンデンサを付けてからテストするべきだった。
* 一般電解コンデンサの方が、発振なる現象を起こさないようだ。
* レギュレータは NJM7805 というシリーズが、こちらの世界では定番のようだ。

![静電容量測定](../CondenserMeasure/README.md) で取り付けたコンデンサを調べてみたが、新品
と同じ値が出た (0.17uF) ので壊してはなさそうだ。コンデンサについては、今のはんだ技術で取り
付けられていると考えて良さそうだ。

対象のコンデンサは リード型積層セラミックコンデンサ 0.1uF 50V 
RPEF11H104Z2P1A01B という村田のものであった。データシートを今一度見返すと、誤差が +80/-20%
というものであった。適当な計測とはいえ、0.17uF は案外正しい数値なのかもしれない。

さて今一度、秋月のマイコン開発ボード(うちでは Arduino Uno R3 互換機) を見てみると、知恵袋
で教わった 7805 レギュレータの Vin, Vout を挟む形で、回路図では 100uF のコンデンサが入って
おり、実際もアルミのコンデンサで 100までは読めるものが入っている。7805 のデータシートの測
定回路の 300-1000 倍が入っている。なるほど、ここまで入れちゃって良いんだ。

とういうとで自作を考えているうちに、ふとツェナーダイオードというものがあることを思いだした。
その時はなに言ってるのか分からなくて、IC になってるレギュレータの方が分かりやすいと思った
ものだが、今なら分かりそうだし、実際に焦がしてみると、ちょっとレギュレータを敬遠したい自分
も居る。それに今回は PIC を動かすだけだから、そんなに精度良く電圧が出なくても良い。

ということで次はツェナーダイオードで 5V 電源作るようにしてみよう。

# PIC12F1840 版 02, ツェナーダイオードで定電圧回路

電圧の上限、下限を調べてみる。単位は V. 

|                                | min | typ | max |
| ---                            | --- | --- | --- |
| 温度センサーIC<br>MCP9700-E/TO | 2.3 | -   | 5.5 |
| PIC12F1840<br>16MHz 駆動       | 2.3 | -   | 5.5 |
| SanAce80                       | 不明| 不明| 不明|

ファンだけは不明なので出たとこ勝負となる。

台湾 Panjit の GDZJ5.1A と US OnSemi の 1N5338BG がある。出力電圧はどっちでも良い。

さてと抵抗を差し込む必要があるのだけど、それはここの定電圧回路の計算式を活用できる。

https://www.paltek.co.jp/techblog/techinfo/210621_01

GDZJ5.1A の場合 Iz = 5mA。PIC の電流など分からん。何パターンか考えてみよう。

1A の場合、$` (12-5.1) (1+0.005)=7 \si{\ohm} `$
