# 抵抗自動選択式静電容量測定器の開発 v1.0

自分で思ってたよりも良く使うので、抵抗を自動で入れ替えるものを作ることにした。

75Ω, 22kΩ, 10MΩの在庫があるので、充電用に使うことにする。ある程度精度が出るであろう、時
定数 1e-3 sec を見たす最小の静電容量は、次の表となる。

| 抵抗 [Ω] | 静電容量 [F] |
| --------- | -----------  |
| 75        | 13u          |
| 22k       | 0.047u       |
| 10M       | 100p         |

こちらによると 200Ωあれば 5V 充電からでも、初期電力 0.125W で 25mA と ATmega328P のピンの許容電流を下回れるので、放電はやはり在庫の 200Ωで一本化することにする。

https://x.gd/iHjnX

今回は、自作の ASOBoard v2.0 に載せるものを設計する。

## 計測のおおまかな流れ

1. 75Ωで測定し、時定数が 1 msec を超えたら測定完了。超えなければ続く
1. 22kΩで測定し、時定数が 1 msec を超えたら測定完了。超えなければ続く
1. 10MΩで測定する。泣いても笑ってもこれが最後。

## 充電、放電のメカニズム

基本的にはデジタルピンのモードを input にすると、浮く (絶縁される) ので、そうすると充電も放
電もできない状態になるため、それを利用する。

デジタルピンは充電用 3ピンと放電用 1ピン。

充電時は、使用する抵抗のピンのみ output の high として、他を input としておく。

放電時は、充電用 3ピンを input として、放電ピンを output の low とする。

何もしないときは全て output の low としておく。

## ソース

[ソース](./arduino/CapacitanceMeter/CapacitanceMeter.ino)

## ユニバーサル基板でのテスト

10uF を超えるコンデンサがないので 75Ωでの計測結果は不明。

22kΩの計測は良好。

10MΩで 22pF を計測すると、106pF と出る。ただし、コンデンサを付けずに測定すると、84pF と出
る。差引 22pF である。すごく雑な考えだけど、コンデンサを付けずに測定することで、浮遊容量を
測定できた、マイコンの遅延とかひっくるめたシステム全体での見かけ上の浮遊容量が測定できた、
ような気がする。22pF 前後のコンデンサがないので、確定ではないが。

これを差し引いても良い気がするけど、自分が分かっていれば良いので、とりあえず出てきたものを、
そのまま表示することにする。

## 回路図

こちらの PDF

[回路図の PDF](./kicad/AutoRegisterSelectorEdition1.0/AutoRegisterSelectorEdition1.0.pdf)

| Reference | Value      | 数量 | 
| --------- | ---------- | ---- | 
| C1        | Any        | 1    | 
| R1        | 75         | 1    | 
| R2        | 22k        | 1    | 
| R3        | 10M        | 1    | 
| R4        | 200        | 1    | 
| U1        | ATmega328P | 1    | 

注意: R1=75Ωだけど、5V/75=67mA で ATmega328P の定格 40mA を超えてしまう。データシート
13.1 節によると逆向きにダイオードが入ってるから、これで、大きな電流を防止するはずだが、そ
うなると充電は遅れることになる (見た目の静電容量は増える)。なので手持ちの 300Ωにしておい
た。

## ASOBoard シールド設計図

![設計図](./librecad/CM_AutoRegSel_1.0.png)

注意: R1=75Ωだけど、5V/75=67mA で ATmega328P の定格 40mA を超えてしまう。データシート
13.1 節によると逆向きにダイオードが入ってるから、これで、大きな電流を防止するはずだが、そ
うなると充電は遅れることになる (見た目の静電容量は増える)。なので手持ちの 300Ωにしておい
た。

## 実装

![実物写真](./photos/静電容量計_自動抵抗選択版.jpg)

これでコンデンサ無しで見た目の浮遊容量は 54pF, 22pF を測ると 78pF となり、差し引き 24pF。
やはり測定できているような気がする。

# 改良 v2.0

別件で、中途半端な個数の抵抗が必要になったので、せっかくなのでこちらも作り直すことにする。

v1.0 の問題点は 1個目の抵抗が 300Ωで、電圧降下を起こしてしまい、見た目の時定数が大きくな
ることで、静電容量を過大に評価してしまう。

1kΩくらいの抵抗であれば、目に見える電圧低下は無いので、1個目を 1kΩとする。

| 抵抗 [Ω] | 時定数 0.1ms の静電容量 [F] | 時定数 1ms の静電容量 [F]| 時定数 100ms の静電容量 [F]|
| --------- | -----------                 | -------------------      | -------------------        |
| 1k        | 0.1u                        |  1u                      |  100u                      |
| 100k      | 1000p                       |  0.01u                   |  1u                        |
| 10M       | 10p                         |  100p                    |  0.01u                     |

10M でだいたい 50pF くらいから測れているようなので 1k, 10M を固定したら、2個目は 100k とい
うことで良いのではないだろうか。

他には放電用抵抗は 300Ωにする。これは単純に在庫の問題

![設計図 v2.0](./librecad/CM_AutoRegSel_2.0.png)

部品表は

| 記号 | 品目、型番等                                              | 個数    |
| ---- | --------------------------------------------------------  | ------- |
| R1   | 1kΩ                                                      | 1       |
| R2   | 100kΩ                                                    | 1       |
| R3   | 10MΩ                                                     | 1       |
| R4   | 300Ω                                                     | 1       |
| PH1-3| ピンヘッダ 2P                                             | 3       |
| PH4  | ピンヘッダ 4P                                             | 1       |
| UB1  | ユニバーサル基板                                          | 1       |
| XH1  | XH ヘッダ 2P                                              | 1       |

あとインターフェースに

| 品目、型番等                                       | 個数  |
| -------------------------------                    | ---   |
| XH ハウジング 2P                                   | 1     |
| ケーブル適当                                       | 2     |
| IC クリップ                                        | 2     |

[ソース](./arduino/CapacitanceMeter2.0/CapacitanceMeter2.0.ino)

1.0 との違いは抵抗値のみ。
