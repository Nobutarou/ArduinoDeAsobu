# コンデンサ静電容量測定

## 考えたり、やってみたこと

参考にしているのはこちら。

https://101010.fun/iot/arduino-measure-capacitance.html

参考サイトの計測終了後の放電のギミックは、電力供給ピン D2 を GND接続、放電ピン D3 も GND接
続にして、両方から放電している。サイトでは D3 から放電と言ってるが、厳密には違う。 

まあ面倒なので放電は 100% D3 から行われるものと仮定して考える。

放電に関しては、こちらで計算できる。

https://www.digikey.jp/ja/resources/conversion-calculators/conversion-calculator-capacitor-safety-discharge

Arduino Uno R3 のデジタルピンは 40mA まで吸える。ということは上記サイトで初期電力が 5V x
40mA = 0.2W までなら、大丈夫ということである。

時定数はこちらのサイトで計算できる。

https://www.digikey.jp/ja/resources/conversion-calculators/conversion-calculator-time-constant

Arduino の ADC はデフォルトで 16MHz/128 での駆動。ADC 一回の動作に 13 サイクル掛かるので、
ADC 1回のループは、1/(16MHz/128)x13 で約 1.0e-4 sec である。しかし ADCSRA レジスタの ADPS
ビットでこの分周比は、仕様上 2 まで小くできる。しかし、テストしたところ、分周比 2 では最初
に何の理由か不明だが1023 と読み取ってしまい、時定数が 0 になってしまった。そのため、実際に
利用できる下限は 4である。

分周比 4 だと 1/(16MHz/4)x13 で約 3.3e-6 sec となる。したがって、時定数は、1e-3 sec あたり
を越えておけば、まずまずの計測ができるだろう。

### ソース、配線図

![ソース](./arduino/main/main.ino)

![配線図](./kicad/CapacityMeasure/静電容量測定配線図.png)

### テスト

|公称静電容量<br>[F]|R1<br>[Ω]|時定数<br>[s]|測定値<br>[F]|補足|
| ---  | --- | ---    | ---   | ---     |
| 0.1u | 10k | 1.00e-3| 0.10u | フィルム|
| 0.1u | 10k | 1.00e-3| 0.14u | セラミック |
| 0.01u| 10k | 1.00e-4| 0.011u| セラミック |
| 22p  | 10k | 2.20e-7| 851p  | セラミック |

おおよそ期待どおりの試験結果かな。

### 静電容量ごとの抵抗選択


|静電容量<br>[F]|R1<br>[Ω]|R2<br>[Ω]|時定数<br>[s]|放電直後の電力消費<br>[W]|1e-2Vまでの放電時間<br>[s]|
|---------------|----------|----------|-------- |-------------------------|-----------|
| 0.01u         | 100k     | 10k      | 1.00e-3 | 2.5e-3 | 6.2e-4 |
| 0.1u          | 100k     | 10k      | 1.00e-2 | 2.5e-3 | 6.2e-3 |
| 1u            | 10k      | 300      | 1.00e-2 | 8.3e-3 | 1.86e-3|
| 100u          | 300      | 300      | 3.00e-2 | 8.3e-2 | 0.19   |
| 22p           | 100M     | 10k      | 2.20e-3 | 2.5e-3 | 1.37e-6 |

10k と 300Ωは手持ちなので優先。100MΩは入手性が悪いなあ。

## PIC でやれるんじゃないの？ → 意味なかった。

PIC12F1840 が手元にあるので、32MHz 駆動のこれなら ADC のカウントを稼げないかということで調
べてみる。ADC が 1ピン、IO に 2ピン、GND と Vdd で、合計 5ピン必要だから、IO 的にはできそうだ。

内部クロックで 32MHz 駆動できて、一応 ADC も最大 32MHz で駆動できる。変換開始から完了まで
11.5 T_AD という時間が掛かり、推奨範囲での最小 T_AD = 1.0usec. 1 ADC サイクルに 1e-5 sec
かかるので、Arduino よりも遅い。

## 時定数まで待つのではなく、時間指定で電圧を掛けるのは？

micros() の分解能が 4us, ``_delay_ms()`` の分解能が 1.25us らしいので、分解能的には時定数
のやりかたと大差ない。しかし抵抗を固定したまま運用できるかもしれない。でも、はんだしちゃっ
た後から 1e3uF 規模の測定がしたくなったりとか考えると余計面倒だし、プログラムの条件分岐と
かも

## PIC 再考

PIC の ``__delay_us()`` は 1us をちゃんと取れるらしい。データシートによると FOSC/4 で動作
するみたいなので 1/(32MHz x 4 ) = 1.25e-7 = 0.125us を取れそうな気がする。まあ取り敢えず
1us が取れるなら十分。

例えば 

1s 電圧掛ける --> 電圧取る. V1
0.1s 電圧掛ける --> 電圧取る. V2
0.01s 電圧掛ける --> 電圧取る. V3
0.001s 電圧掛ける --> 電圧取る. V4

実際には電圧といってもアナログ入力なので 1023x0.632=647 に最も近いものを選択。

Vc: コンデンサ電圧, V0: 全体の電圧, t: 採用した充電時間, R: 抵抗, C: 静電容量とすれば

$Vc = V0 ( 1 - e^{- \frac{t}{RC}})$

よって

$C=-\frac{t}{R}\frac{1}{\ln(1-\frac{Vc}{V0}}$
