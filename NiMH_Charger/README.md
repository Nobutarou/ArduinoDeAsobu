# NiMH 充電器

## version 1.0
<!-- {{{ -->
最初は MAX713 と言うのを考えたが、電源要求電圧が 6V 以上であり、自分が充電してみたいのは、
とりあえず 1本、大体、1V くらいまで低下してる電池とすると、ざっくり 5V は捨てることになる
ので、あまりに非効率なため、却下。

そこで ATMega8 で似たようなことをやってる方がいるので参考にする。

https://pa5m-med60.hatenablog.com/entry/2023/03/21/195354

この方は 5V 電源で 3本充電しているようだ。いろいろ回路シミュレーションしながら分かったこと

- 充電中は電池電圧が上がり、1.4V~1.5V で推移する。
  - https://chibim.com/%E5%85%85%E9%9B%BB/
- 電圧に余裕がないとトランジスタは電流を一定に保てない
  - MAX713 は電池電圧に +1.5V は必要としている
- 参考回路の方はトランジスタベース電圧に 100Ω、Icb=43mA くらいになるから理想的には 4.3A
  とか流れることになるが、実際は電池 1.45Vx3 = 4.35V に対して 600mA 弱である
  - https://tinyurl.com/2ytdbwou
- Icb 増やしていくど、だんだん倍率が低くなる。

というか、全然定電流にできていない。結局トランジスタは単なるスイッチにしかなっていない感じ。

それを踏まえて、3.3V 電源で電池 1本 1C を目指すと、こんな感じ。実際はファームウェアで PWM
のデューティを 90% くらいにしてるので 0.9C くらい。

https://tinyurl.com/2b6jf37f

トランジスタの消費電力 Pc=1.84W (電池充電電圧 1.45V にて)。秋月での PNP トランジスタ一番人
気の TTA008B は、ヒートシンクなしで 1.5W までなのでヒートシンクが必要。

熱抵抗値がデータシートに無いが、図7-9 (https://x.gd/xnZYc) より、ヒートシンク無限大のとき
ジャンクション温度 Tj と雰囲気温度 Ta の差 dTja=125K で P=10W 発熱できる。ヒートシンク無限
大なので雰囲気温度 Ta とケース温度 Tc は一致していると見なせる。つまりジャンクション温度と
ケース温度の差 dTjc = dTja とこの場合は見なせる。したがってジャンクション、ケース間の熱抵
抗 Rjc は

$`_{jc} = \frac{dT_{jc}}{P}`$ 

今回は Rjc = 12.5 K/W となる。

ではここからヒートシンクを付けたときの許容損失 P を求めたい。

ヒートシンクの熱抵抗を Rca とする。温度が定常になった状態ではジャンクションからケースに流
れる熱とケースから空気に流れる熱は等しく P であるから

$`P=\frac{dT_{jc}}{R_{jc}}=\frac{dT_{ca}}{R_{ca}}`$

またケースと空気の温度差を dTca とすると 

$`dT_{ja}=dT_{jc}+dT_{ca}`$

この二つの式で未知なのは P, dTjc, dTca である。dTja はジャンクションの許容最大温度と運用環
境温度差なので既知である。式が 3 個に未知数 3個だから、この未知数は求まる。

$`dT_{ca}=\frac{dT_{ja}}{\frac{R_{jc}}{R_{ca}}+1}`$

と dTca が求まるので、あとはなしくずして

$`dT_{jc}=dT_{ja}-dT_{ca}`$

$`P=\frac{dT_{ca}}{R_{ca}}`$

と決まる。本当はケースとヒートシンクの間もあるんだが、とりあえずそんなにぎりぎりを目指さな
いなら十分だろう。まあ CPU グリスでも塗っておこう。

例えば水谷電機の SP111K (TO-220用と書いてあるが TTA008B が付かないようには見えない)
Rca=32.4K/W の場合、dTja=125K の最悪条件で P=2.8W となる。シミュレーションだと電池充電電圧
1V まで行ける。これは最小クラスで 13x9x18.5mm である。

ただ、そもそも充電抵抗を 0.47Ωから 1Ωにすると、充電電圧 1.45V のときに 1.7A と 0.2A ほど
下がるが、充電電圧 0.6V で 1.5W のヒートシンク無しのところまで行ける。

https://tinyurl.com/289rhg9m

ヒートシンクでこれに対抗しようとすると一回り大きい 16x16x25mm で 20W/K クラスが必要になる。
割に合う気がしない。これは CPU のオーバークロックや、最適化のやりすぎと同じで割に合わない。
ヒートシンクの選び方を身に付けたから OK としよう。
<!-- }}} -->

## version 2.0
<!-- {{{ -->
全開うやむやで終ってしまったので、もう一度 MAX712 or 713 で考えてみる。712 はエレショップ
で売っていて 713 は秋月で売っている。

[データシート](https://www.analog.com/media/jp/technical-documentation/data-sheets/MAX712-MAX713_jp.pdf)

で気になるのは Q1 トランジスタの発熱。一番厳しいのは急速充電開始直後のセルの電圧が低くて電
流が大きいときのはず。とりあえず 図4 を参考にするとセルは 1.35V としてみる。

セル 3個、入力電源 12V、ダイオード D1 の Vf=0.6V と仮定、Vsense=0.25V ならば Q1 での電圧降
下は $`12-(3*1.35+0.6+0.25)=7.1`$ V。TO パッケージのトランジスタの生許容損失が 1.5W なので
200mA 程度となる。 

うーんやっぱり面倒くさいな。それになんとなく直列で充電するのってどうなのという気がする。先
に充電が終ったセルにいつまでも電流流れるんだよね。
<!-- }}} -->

## version 3.0

何も作っていないけど v3.0

こんな感じでシンプルに充電したら良いのではないか。Nch MOSFET かフォトリレーを使って、マイ
コンの PWM で電流を調整したら良いんじゃないのか、と思い直す。トランジスタに発熱させるより、
金属板抵抗やセメント抵抗に発熱させた方が話が簡単な気がする。それに一本ごとに充電できるよう
にしたい。それにやはりマイコンで遊ぶべきだろう。

https://tinyurl.com/28vmjkox

ルールは MAX713 を参考にしてみる。細かい数値は現物で調整

- 入力電源は 3.3V
- 抵抗は 5W1ΩMPC74-1ohmJ 福島双羽
- 電池電圧は充電停止して測定
- 電池電圧 0.5V までは 100mA になるように PWM 制御
- 0.5V 以上は 1A になるように PWM 制御
  - 充電中は電池の電圧が上がる (抵抗の電圧は下がる) ので、実際はもう少し小さくなるはず
- 60秒ごとに電圧測定。
  - MAX713 は C/2 なら 84秒ごとの測定
- 1.2V 以上で変化無し、もしくは低下したら終了
- 1.3V 到達で終了
  - 満充電である必要もない
- 最長 120分で終了
- マイコンは PIC12F1501
  - なんか書いてみたら収まった。
  - 1個で上手くいったら、そのまま増やせば良い。
  - PWM には速さが欲しく、充電時間を考えると遅くしたいが、なんとなく 8MHz 駆動となった。

電源電圧 Vin, 電池電圧 Vbat、抵抗 R とすると制御なしでの最大電流 Iorg は

$Iorg=\frac{Vin-Vbat}{R}$

ADC の電圧測定値的には Vin --> 1023 であるから、Vbat の読み値を ADCbat とすると

$Vin:Vbat=1023:ADCbat$

だから

$Vbat=\frac{Vin ADCbat}{1023}$

だから

$I_{org}=\frac{V_{in}}{R}\frac{1023-ADC_{bat}}{1023}$

Vbat=0.5V までは I=0.1A にしたい。PWN のデューティは 0-255 ということにコードを書いた結果なっ
たので、デューティ D は 

$D:255=0.1:I_{org}$

よって D=25.5/Iorg なわけだけど、ここに ADCbat での Iorg 式を加味すると

$D=\frac{26086 R}{V_{in}(1023-ADC_{bat}}$

R=1Ω, Vin=3.3Vの場合こうなる。整数演算で十分そうだ。

$D=\frac{7905}{1023-ADC_{bat}}$

それ以降は 1A にしたいので 10倍すれば良い

可読性的には毎回小数点演算で電圧、電流を計算した方が良いが節約を優先した。

MOSFET のゲートと入力端子の間には抵抗を入れるのが一般的らしい。検討している N-MOS はサンケ
ンの EKI04036。オン抵抗が 3.1mΩと非常に低い。まあ 1A や 0.1mA でどうなるのか知らんけど。

Turn-On Delay Time が Vgs=10V, Rg=4.7Ωで 6.2ns とある。Vgs=2.0V とあるので、これくらいな
ら電流の減少は無視できるとして、電荷は 10/4.7 x 6.2e-9 = 1.319e-8C である。

2V なので 6.595e-9 F = 6.6nF くらいである。

一方 PIC12F1501 の通常のピンの出力電流は 25mA とデータシートの表紙にある。最大定格に 50mA
とあるけど、これはかなり電圧も下がっているはず。先が読めないのは計算に困るので
3.3V/25mA=132Ωとなると手持ちでは 300Ω.

3.3V 入力で 2V って、おおよそ時定数なので Digikey の時定数カルキュレータで 2e-6秒となった。
500kHz 相当なのでコードでの PWM 31kHz に対しては十分な速度が出るだろう。

プルダウン抵抗 Rgs は、Igss=100nA とあるので 100kΩなら誤差ΔV=0.01V で、gs=3.29Vと誤差と
電圧降下の良いバランスだろう。

ただし、どちらも多分必要ない。電流を制限しなくてはならないほどピンから電流出せないし、グラ
ンドはマイコント MOS で共通だから、誤動作も考えにくい。ジャンパ線にしておいて、必要なら繋
ぐ形にする。

[ソース](./src/v3.0_pic/main.c)

[回路図](./kicad/NiMhCharger3.0/NiMhCharger3.0.pdf)

部品表

| 記号    | 品目、型番等                  | 個数 |
| ---     | ---                           | ---  |
| C12-13  | セラコン 0.1uF                | 3    |
| Cxx     | 在庫処分コンデンサ            | 適量 |
| D11-13  | LED                           | 3    |
| DC1-3   | 電池ケース SN3-1PC            | 3    |
| IS11-13 | IC ソケット 8P                | 3    | 
| PH1-6   | ピンヘッダ 2P                 | 6    |
| PS1-6   | ピンソケット 2P               | 6    |
| Q11-13  | Nch MOSFET, EKI04036          | 3    |
| R11-13  | 抵抗 MPC74-1ohmJ              | 3    |
| R21-23  | 抵抗 2.7kΩ                   | 3    |
| R31-33  | 抵抗 300Ω、ジャンパ線で様子見| 3    |
| R41-43  | 抵抗 100kΩ、未実装で様子見   | 3    |
| T1      | ターミナル 2P                 | 1    |
| U11-13  | PIC12F1501                    | 3    |
| UB1,2   | ユニバーサル基板 26x21P       | 2    |
